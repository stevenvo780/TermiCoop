FROM debian:unstable

RUN apt-get update \
  && apt-get install -y --no-install-recommends ca-certificates curl passwd \
  && rm -rf /var/lib/apt/lists/*

# Avoid systemd hard dependency during package install inside containers.
RUN printf '#!/bin/sh\nexit 0\n' > /usr/bin/systemctl \
  && chmod +x /usr/bin/systemctl

COPY dist/packages /tmp/packages
RUN dpkg -i /tmp/packages/ultimate-terminal-nexus_*.deb

# Expose worker packages for remote installs
RUN mkdir -p /usr/share/ultimate-terminal/downloads \
  && if ls /tmp/packages/ultimate-terminal-worker_*.deb >/dev/null 2>&1; then \
       cp /tmp/packages/ultimate-terminal-worker_*.deb /usr/share/ultimate-terminal/downloads/; \
       deb_file=$(ls /tmp/packages/ultimate-terminal-worker_*.deb | head -n 1); \
       cp "$deb_file" /usr/share/ultimate-terminal/downloads/worker-linux.deb; \
     fi \
  && if ls /tmp/packages/ultimate-terminal-worker-*.rpm >/dev/null 2>&1; then \
       cp /tmp/packages/ultimate-terminal-worker-*.rpm /usr/share/ultimate-terminal/downloads/; \
       rpm_file=$(ls /tmp/packages/ultimate-terminal-worker-*.rpm | head -n 1); \
       cp "$rpm_file" /usr/share/ultimate-terminal/downloads/worker-linux.rpm; \
     fi

ENV PORT=3002
WORKDIR /var/lib/ultimate-terminal

EXPOSE 3002
CMD ["/usr/bin/ultimate-terminal-nexus"]
